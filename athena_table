DROP TABLE IF EXISTS ct_logs.cloudtrail_events_bydate;
CREATE EXTERNAL TABLE ct_logs.cloudtrail_events_bydate (
  eventVersion string,
  userIdentity struct<
    type:string,
    principalId:string,
    arn:string,
    accountId:string,
    invokedBy:string,
    accessKeyId:string,
    sessionContext:struct<
      attributes:struct<mfaAuthenticated:string,creationDate:string>,
      sessionIssuer:struct<type:string,principalId:string,arn:string,accountId:string,userName:string>
    >
  >,
  eventTime string,
  eventSource string,
  eventName string,
  awsRegion string,
  sourceIPAddress string,
  userAgent string,
  errorCode string,
  errorMessage string,
  requestParameters string,
  responseElements string,
  additionalEventData string,
  requestID string,
  eventID string,
  readOnly string,
  resources array<struct<arn:string,accountId:string,type:string>>,
  eventType string,
  apiVersion string,
  recipientAccountId string,
  serviceEventDetails string,
  sharedEventID string,
  vpcEndpointId string,
  eventCategory string
)
PARTITIONED BY (dt date)
ROW FORMAT SERDE 'com.amazon.emr.hive.serde.CloudTrailSerde'
STORED AS INPUTFORMAT 'com.amazon.emr.cloudtrail.CloudTrailInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION 's3://LOG_BUCKET/AWSLogs/ACCOUNT_ID/CloudTrail/us-east-1/'
TBLPROPERTIES (
  'projection.enabled'='true',
  'projection.dt.type'='date',
  'projection.dt.range'='2020-01-01,NOW',
  'storage.location.template'='s3://LOG_BUCKET/AWSLogs/ACCOUNT_ID/CloudTrail/us-east-1/${dt}/'
);
