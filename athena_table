-- ===== Inputs =====
WITH params AS (
  SELECT
    'your-bucket-name' AS bucket,      -- << change
    'us-east-1'        AS region,      -- << change if needed
    DATE '2025-03-01'  AS put_start,   -- first month to include PUTs (YYYY-MM-01)
    DATE '2025-08-01'  AS put_end,     -- last month to include PUTs   (YYYY-MM-01)
    12                 AS read_ext_mo  -- extend GET scan window by N months beyond put_end
),

-- Months to scan for PUTs (exact window)
months_put AS (
  SELECT date_format(d,'%Y') AS yr, date_format(d,'%m') AS mo
  FROM params, UNNEST(SEQUENCE(put_start, put_end, INTERVAL '1' MONTH)) t(d)
),

-- Months to scan for GETs (PUT window + N months)
months_get AS (
  SELECT date_format(d,'%Y') AS yr, date_format(d,'%m') AS mo
  FROM params, UNNEST(SEQUENCE(put_start, put_end + INTERVAL (SELECT read_ext_mo FROM params) MONTH, INTERVAL '1' MONTH)) t(d)
),

-- First write per object within the PUT window
puts AS (
  SELECT
    try(json_extract_scalar(requestparameters,'$.bucketName')) AS bucket,
    try(json_extract_scalar(requestparameters,'$.key'))        AS object_key,
    min(from_iso8601_timestamp(eventtime))                    AS first_put
  FROM ct_logs.cloudtrail_events t
  JOIN months_put mp ON t.year = mp.yr AND t.month = mp.mo
  JOIN params p      ON t.region = p.region
  WHERE t.eventsource = 's3.amazonaws.com'
    AND try(json_parse(requestparameters)) IS NOT NULL
    AND json_extract_scalar(requestparameters,'$.bucketName') = (SELECT bucket FROM params)
    AND eventname IN ('PutObject','CopyObject','CompleteMultipartUpload')
  GROUP BY 1,2
),

-- All reads for those objects in the extended window
gets AS (
  SELECT
    try(json_extract_scalar(requestparameters,'$.bucketName')) AS bucket,
    try(json_extract_scalar(requestparameters,'$.key'))        AS object_key,
    from_iso8601_timestamp(eventtime)                         AS ts
  FROM ct_logs.cloudtrail_events t
  JOIN months_get mg ON t.year = mg.yr AND t.month = mg.mo
  JOIN params p      ON t.region = p.region
  WHERE t.eventsource = 's3.amazonaws.com'
    AND try(json_parse(requestparameters)) IS NOT NULL
    AND eventname = 'GetObject'
    AND json_extract_scalar(requestparameters,'$.bucketName') = (SELECT bucket FROM params)
)

-- Per-object lifecycle: first_put, last_get, total_reads, and gap in months/days
SELECT
  p.bucket,
  p.object_key,
  p.first_put,
  MAX(g.ts)                                          AS last_get,
  COUNT(g.ts)                                        AS total_reads,
  date_diff('month', p.first_put, MAX(g.ts))         AS months_from_put_to_last_get,  -- NULL if never read
  date_diff('day',   p.first_put, MAX(g.ts))         AS days_from_put_to_last_get     -- NULL if never read
FROM puts p
LEFT JOIN gets g
       ON g.bucket = p.bucket AND g.object_key = p.object_key
GROUP BY 1,2,3
ORDER BY months_from_put_to_last_get DESC NULLS LAST
LIMIT 5000;
