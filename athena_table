WITH ev AS (
  SELECT DISTINCT
    c.eventid,
    COALESCE(
      json_extract_scalar(c.requestparameters, '$.bucketName'),
      regexp_extract(r.arn, 'arn:aws:s3:::([^/]+)', 1)
    ) AS bucket,
    c.eventname,
    c.eventtime
  FROM ct_logs.cloudtrail_events c
  LEFT JOIN UNNEST(c.resources) AS t(r)
  WHERE c.eventsource = 's3.amazonaws.com'
    AND c.year  = '2025'
    AND c.month = '08'
    AND c.day   = '16'
    AND DATE(from_iso8601_timestamp(c.eventtime)) = DATE '2025-08-16'
)
