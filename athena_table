WITH ev AS (
  SELECT DISTINCT
    c.eventid,
    c.eventname,
    COALESCE(
      json_extract_scalar(c.requestparameters, '$.bucketName'),
      regexp_extract(r.arn, 'arn:aws:s3:::([^/]+)', 1)
    ) AS bucket,
    COALESCE(
      json_extract_scalar(c.useridentity, '$.arn'),
      json_extract_scalar(c.useridentity, '$.sessionContext.sessionIssuer.arn')
    ) AS principal
  FROM ct_logs.cloudtrail_events c
  LEFT JOIN UNNEST(c.resources) AS t(r) ON TRUE
  WHERE c.eventsource = 's3.amazonaws.com'
    AND c.year  = '2025'
    AND c.month = '08'
    AND c.day   = '16'
    AND DATE(from_iso8601_timestamp(c.eventtime)) = DATE '2025-08-16'
    AND (
      json_extract_scalar(c.requestparameters, '$.bucketName') IS NOT NULL
      OR regexp_extract(r.arn, 'arn:aws:s3:::([^/]+)', 1) IS NOT NULL
    )
)

SELECT
  eventname,
  principal,
  COUNT(DISTINCT eventid) AS total_requests
FROM ev
WHERE bucket = 'aws-cloudtrail-logs-764973944252-acca46c5'   -- your bucket here
GROUP BY eventname, principal
ORDER BY eventname, total_requests DESC;
