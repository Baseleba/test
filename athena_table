SELECT 
    eventname,
    COUNT(*) AS total_requests
FROM ct_logs.cloudtrail_events
WHERE eventsource = 's3.amazonaws.com'
  AND year = '2025' AND month = '08' AND day = '16'
  AND (
    json_extract_scalar(requestparameters, '$.bucketName') = 'aws-cloudtrail-logs-764973944252-acca46c5'
    OR regexp_extract(arn, 'arn:aws:s3:::([^/]+)', 1) = 'aws-cloudtrail-logs-764973944252-acca46c5'
  )
CROSS JOIN UNNEST(resources) AS t(arn)
GROUP BY 1
ORDER BY total_requests DESC;
