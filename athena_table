WITH bucket_filter AS (
  SELECT 'aws-cloudtrail-logs-764973944252-acca46c5' AS bucket
)
SELECT
  COALESCE(
    -- IAM user (two schema variants)
    try(e.useridentity."userName"),
    try(e.useridentity.username),

    -- STS assumed role name (two schema variants)
    try(e.useridentity."sessionContext"."sessionIssuer"."userName"),
    try(e.useridentity.sessioncontext.sessionissuer.username),

    -- Fall back to last segment of ARN (works for roles and service principals)
    regexp_extract( try(e.useridentity.arn), '.*/([^/]+)$', 1),

    -- Final fallbacks (two schema variants)
    try(e.useridentity."principalId"),
    try(e.useridentity.principalid),

    -- If nothing above, at least show where it came from
    try(e.invokedby),
    try(e.sourceipaddress)
  ) AS username_or_principal,
  COUNT(DISTINCT e."requestID") AS request_count
FROM ct_logs.cloudtrail_events e
LEFT JOIN UNNEST(e.resources) AS t(r) ON TRUE
CROSS JOIN bucket_filter bf
WHERE e.eventsource = 's3.amazonaws.com'
  AND e.year = '2025' AND e.month = '08' AND e.day = '16'
  AND (
       json_extract_scalar(e.requestparameters, '$.bucketName') = bf.bucket
       OR (
            r.type IN ('AWS::S3::Bucket','AWS::S3::Object')
            AND regexp_extract(r.arn, 'arn:aws:s3:::([^/]+)', 1) = bf.bucket
          )
      )
GROUP BY 1
ORDER BY request_count DESC;
