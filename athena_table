WITH bucket_events AS (
  SELECT
    coalesce(
      json_extract_scalar(requestparameters, '$.bucketName'),
      regexp_extract(r.arn, 'arn:aws:s3:::([^/]+)', 1)
    ) AS bucket,
    eventname
  FROM ct_logs.cloudtrail_events c
  CROSS JOIN UNNEST(c.resources) AS t(r)
  WHERE eventsource = 's3.amazonaws.com'
    AND year = '2025'
    AND month = '08'
    AND day = '16'
    AND DATE(from_iso8601_timestamp(eventtime)) = DATE '2025-08-16'
)
SELECT
  bucket,
  eventname,
  COUNT(*) AS total_requests
FROM bucket_events
WHERE bucket = 'aws-cloudtrail-logs-764973944252-acca46c5'
GROUP BY bucket, eventname
ORDER BY total_requests DESC;
