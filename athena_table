WITH from_req AS (
  SELECT
    json_extract_scalar(requestparameters, '$.bucketName') AS bucket,
    eventname,
    eventtime
  FROM ct_logs.cloudtrail_events
  WHERE eventsource = 's3.amazonaws.com'
    AND year = '2025' 
    AND month = '08' 
    AND day = '16'
    AND DATE(from_iso8601_timestamp(eventtime)) = DATE '2025-08-16'
    AND json_extract_scalar(requestparameters, '$.bucketName') IS NOT NULL
)
SELECT
  bucket,
  eventname,
  COUNT(*) AS total_requests
FROM from_req
WHERE bucket = 'aws-cloudtrail-logs-764973944252-acca46c5'
GROUP BY bucket, eventname
ORDER BY total_requests DESC;
