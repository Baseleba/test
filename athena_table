-- 1) Create (or switch to) your database
CREATE DATABASE IF NOT EXISTS ct_logs;
USE ct_logs;

-- 2) Create the CloudTrail table with partition projection
CREATE EXTERNAL TABLE IF NOT EXISTS cloudtrail_events (
  eventVersion               string,
  userIdentity               struct<
    type:string,
    principalId:string,
    arn:string,
    accountId:string,
    invokedBy:string,
    accessKeyId:string,
    sessionContext:struct<
      attributes:struct<mfaAuthenticated:string,creationDate:string>,
      sessionIssuer:struct<type:string,principalId:string,arn:string,accountId:string,userName:string>
    >
  >,
  eventTime                  string,
  eventSource                string,
  eventName                  string,
  awsRegion                  string,
  sourceIPAddress            string,
  userAgent                  string,
  errorCode                  string,
  errorMessage               string,
  requestParameters          string,
  responseElements           string,
  additionalEventData        string,
  requestID                  string,
  eventID                    string,
  readOnly                   string,
  resources                  array<struct<arn:string,accountId:string,type:string>>,
  eventType                  string,
  apiVersion                 string,
  recipientAccountId         string,
  serviceEventDetails        string,
  sharedEventID              string,
  vpcEndpointId              string,
  eventCategory              string
)
PARTITIONED BY (region string, year string, month string, day string)
ROW FORMAT SERDE 'com.amazon.emr.hive.serde.CloudTrailSerde'
STORED AS INPUTFORMAT 'com.amazon.emr.cloudtrail.CloudTrailInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION 's3://LOG_BUCKET/AWSLogs/ACCOUNT_ID/CloudTrail/'
TBLPROPERTIES (
  'projection.enabled'='true',
  'projection.region.values'='us-east-1',                         -- comma-separate if multiple regions
  'projection.year.type'='integer',  'projection.year.range'='2020,2035',
  'projection.month.type'='integer', 'projection.month.range'='1,12',  'projection.month.digits'='2',
  'projection.day.type'='integer',   'projection.day.range'='1,31',    'projection.day.digits'='2',
  'storage.location.template'='s3://LOG_BUCKET/AWSLogs/ACCOUNT_ID/CloudTrail/${region}/${year}/${month}/${day}/'
);
